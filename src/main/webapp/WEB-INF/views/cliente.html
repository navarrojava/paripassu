<!DOCTYPE html>
<html ng-app="navarro">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=500, user-scalable=yes">
<link rel="stylesheet" href="/resources/css/bootstrap.min.css">
<link rel="stylesheet" href="/resources/css/custom.css">
<script src="/resources/js/angular.min.js"></script>
<script type="text/javascript">
		angular.module("navarro",[]);
		angular.module("navarro").controller("navarroCtrl", function  ($scope, $http) {
			
			$scope.titulo = "Retire sua senha";
			$scope.senhas = [];
			$scope.quantidade = 1;
			$scope.teste = [];
			$scope.minhaSenha = JSON.parse(localStorage.getItem("senha"));
			$scope.verificaSeFuiChamado = function(){
				 if   ( JSON.stringify(localStorage.getItem("senha")).length > 0 && localStorage.getItem("senha")) {
						$scope.minhaSenha = JSON.parse(localStorage.getItem("senha"));
				   } else {
					$scope.minhaSenha =   {
						   "id": 0,
						   "numero": 1,
						   "tipoSenha": "GERAL",
						   "mascaraSenha": "A0000"
						 }
				   }
	        		$http.post("http://localhost:8080/cliente/verifica-se-fui-chamado",$scope.minhaSenha).success(function(data, status){
	        			if (data.id == 0 ) {
							   $scope.minhaSenha.mascaraSenha = "A0000";
	        			}
				}).error(function(data, status){
			});
		};
			
			var intervalo = window.setInterval ( function () {
				$http.get("http://localhost:8080/gerente/todas-as-senhas").success(function (data) {
					if (data == undefined || !data){
						$scope.message = "Não há nimguém na fila";
						$scope.senhas = "";
						 $scope.minhaSenha.mascaraSenha = "A0000";
					}else{
						$scope.message = "";
						$scope.senhas = data;
					}
			}).error(function (data, status) {
				$scope.message = "Aconteceu um problema: " + data;
			});
		}, 1000);
			
			$scope.solicitarSenha = function(tipoSenha) {
				$http.get("http://localhost:8080/cliente/solicitar-senha?tipo="+tipoSenha).success(function (data) {
					$scope.minhaSenha = data;
					localStorage.setItem("senha", JSON.stringify($scope.minhaSenha));
					$scope.teste = localStorage.getItem("senha");

			}).error(function (data, status) {
				$scope.message = "Aconteceu um problema: " + data;
			});
   		}
	});	    
	</script>

<title>Angular JS @Navarro</title>
</head>
<body ng-controller="navarroCtrl" data-ng-init="verificaSeFuiChamado()">
	<div class="jumbotron">
		<div>
			<h2>{{titulo}}</h2>
		</div>
		<table class="table table-striped" ng-hide="minhaSenha.mascaraSenha == 'A0000'">
			<tr>
				<th class="text-custom">Minha senha</th>
			</tr>
			<tr>
				<td class="form-control">{{minhaSenha.mascaraSenha}}</td>
			</tr>
		</table>
		
		<div class="alert alert-danger" ng-show="message.length>0">{{message}}</div>
		<table class="table table-striped">
			<tr>
				<th class="text-custom">Senha atual</th>
			</tr>
			<tr ng-repeat="senha in senhas | limitTo:quantidade">
				<td class="form-control">{{senha.mascaraSenha}}</td>
			</tr>
		</table>
		<button class="btn btn-primary btn-block" ng-click="solicitarSenha('NORMAL')">NORMAL</button>
		<button class="btn btn-warning btn-block" ng-click="solicitarSenha('PREFERENCIAL')">PREFERENCIAL</button>
	</div>
</body>
</html>
